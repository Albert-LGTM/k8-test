---
- name: Run the OCM join command on all spoke clusters
  ansible.builtin.shell: >
    clusteradm join
    --hub-token '{{ ocm_token }}'
    --hub-apiserver {{ hub_apiserver.stdout }}
    --cluster-name '{{ item }}'
  environment:
    KUBECONFIG: "{{ hostvars[item].kubeconfig }}"
  delegate_to: "{{ item }}"
  loop: "{{ groups['spoke_clusters'] }}"
  register: join_output

- name: Accept the cluster join request on the hub
  ansible.builtin.command: >
    clusteradm accept --clusters {{ item }}
  delegate_to: "{{ groups['hub_cluster'][0] }}"
  loop: "{{ groups['spoke_clusters'] }}"
  environment:
    KUBECONFIG: "{{ hostvars[groups['hub_cluster'][0]].kubeconfig }}"

